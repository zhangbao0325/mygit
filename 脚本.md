1 从线上数据库导一部分数据到本地

```
#!/bin/bash

SQL='/usr/local/src/dbsync/gwstat.sql'
DATABASE='gwstat'
YEAR=`date +%Y年%m月%d日`

rm -rf $SQL
echo "删除成功"

mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_delay_request >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_gw_pandect >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_pv_count >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_pv_count_hour >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_pv_count_wd >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_request_body >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_request_time >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_response_timeout_1 >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_response_timeout_1_dup >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_response_timeout_5 >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_response_timeout_5_dup >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_stat >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_status_error >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_status_error_top10 >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_upstream_status_error >> $SQL
mysqldump --single-transaction -h42.62.98.68 -uxes_arch_select -pL86bHeJk4pkhnjKDOybz8pgqpj8Mt9XP -P28306 --quick  -w"1 = 1 order by created_at desc LIMIT 50000"  --databases $DATABASE --tables xes_pv_req_wd  >> $SQL

echo "Dump成功"

mysql -h10.99.1.243 -uroot -p123456 -e "drop database if exists $DATABASE;create database $DATABASE;use $DATABASE"
mysql -h10.99.1.243 -uroot -p123456 -f $DATABASE < $SQL

echo "[$YEAR:] Dump ok" > ./sync.log
```

2 配置yum源
配置priorities+rpmforge

```
#! /bin/bash

sudo su
yum install -y wget
yum install -y yum-priorities

cd /usr/local/src
wget http://www.rpmfind.net/linux/dag/redhat/el7/en/x86_64/dag/RPMS/rpmforge-release-0.5.3-1.el7.rf.x86_64.rpm

rpm -ivh rpmforge-release-0.5.3-1.el7.rf.x86_64.rpm

cd /etc/yum.repos.d/
wget http://mirrors.163.com/.help/CentOS6-Base-163.repo
mv CentOS6-Base-163.repo CentOS-Base.repo

yum makecache
```


3 建立主机间ssh互信，免密登录
假设有四台主机：   
192.168.23.200 zhangbao   
192.168.23.201 zhangbao1   
192.168.23.202 zhangbao2   
192.168.23.203 zhangbao3   
提前修改主机名，并重启：   
```
以zhangbao1为例：
1 vim /etc/sysconfig/network
  HOSTNAME=zhangbao1
2 vim /etc/hosts
  192.168.23.200 zhangbao
  192.168.23.202 zhangbao2
  192.168.23.203 zhangbao3
3 reboot
```

要让zhangbao与其他三台建立ssh互信：
1 在zhangbao主机上：
```
   1 ssh-keygen
   2 在 /etc/hosts添加其他主机的host和ip
   3 yum -y install except 
   4 chmod +x ssh.sh
   5 sh ssh.sh
```
2 执行脚本:
```
#!/bin/bash

SERVERS="zhangbao1 zhangbao2 zhangbao3"
PASSWORD=123456

auto_ssh_copy_id() {
    expect -c "set timeout -1;
        spawn ssh-copy-id $1;
        expect {
            *(yes/no)* {send -- yes\r;exp_continue;}
            *assword:* {send -- $2\r;exp_continue;}
            eof        {exit 0;}
        }";
}

ssh_copy_id_to_all() {
    for SERVER in $SERVERS
    do
        auto_ssh_copy_id $SERVER $PASSWORD
    done
}

ssh_copy_id_to_all  
```
更加简单的方式：
```
ssh-keygen
ssh-copy-id zhangbao2
```

注意：配置了免密登录之后仍然需要输入密码，是由于文件权限的问题：
参考：https://blog.csdn.net/weixin_40678969/article/details/78992296
```
   修改双方的chmod -R 700 /home/hadoop/
```


3 nginx的日志切割
```
#!/bin/bash
LOG=/usr/local/openresty/nginx/logs/error.log
DESTPATH=/tmp/data
BACKLOG=$(date -d yesterday +%Y%m%d%H%M).error.log
mv $LOG $DESTPATH/$BACKLOG
touch $LOG
kill -USR1 `cat /usr/local/logs/nginx.pid`
```


4  curl请求查看线上的nginx状态：
```
#!/bin/bash
Appid=2000037;
appkey="103864ce8aa1e9d7a8f51b6deb3fd72b"

#获取13位时间戳
current=`date "+%Y-%m-%d %H:%M:%S"`
timeStamp_s=`date -d "$current" +%s`
#将current转换为时间戳，精确到毫秒  
TimeStamp=$((timeStamp_s*1000+`date "+%N"`/1000000))

#MD5加密得出签名
Sign=$(echo -n ${Appid}"&"${TimeStamp}$appkey|md5sum|cut -d ' ' -f1);
#curl -v 10.10.88.11/nginx_status -H "X-Auth-Appid:${Appid}" -H "X-Auth-TimeStamp:${TimeStamp}" -H "X-Auth-Sign:${Sign}"
curl -v ${1}/nginx_status -H "X-Auth-Appid:${Appid}" -H "X-Auth-TimeStamp:${TimeStamp}" -H "X-Auth-Sign:${Sign}"

```


5 php模拟curl线上的机器
curl -x 127.0.0.1:80 test.xesv5.com/varnish_health_check -H "X-Auth-Appid:1000001" -H "X-Auth-Sign:602fee3d1f7bc49c5c15d13f2ea3ccfe" -H "X-Auth-TimeStamp:1535972721"
curl -d 'method=PUT&key=/admin.alarm.xesv5.com/public/busiConf.php&data=zhangbao' http://internalapi.xesv5.com/configure/sync -H "Accept: application/prs.internal-api.1.0.0+json" -H "X-Auth-Appid:1000001" -H "X-Auth-Sign:602fee3d1f7bc49c5c15d13f2ea3ccfe" -H "X-Auth-TimeStamp:1535972721"
```
<?php
    $Appid=2001146;
    $time=1535972721;
    $appkey="7309855d2c64ab624251279cadf0013f";

    $Sign=md5($Appid . '&' . $time . $appkey);
    //    $auth = [];
    //    $auth['X-Auth-Appid'] = $Appid;
    //    $auth['X-Auth-TimeStamp'] = $time;
    //    $auth['X-Auth-Sign'] = $Sign;
    //     $auth['Host'] = "aisouti.xueersi.com";
       $auth =array(
                "X-Auth-appid:".$Appid,
                "X-Auth-TimeStamp:".$time,
                "X-Auth-Sign:".$Sign,
                "Host:aisouti.xueersi.com",
                );
                
       # $url = "http://10.10.88.54:80";
        $url = "http://10.10.18.21:18128";
        
        $imgUrl ="http://xesfile.xesimg.com/question_orc_search/1535701362.png";
        $data = "";
        $data .= "\r\n--PP**ASR**LIB_a\r\n";
        $data .= '"sid":"1","idx":"2","imageLength":"0","URL":"' . $imgUrl . '"';
        $data .= "\r\n--PP**ASR**LIB_b\r\n";
        $data .= "\r\n--PP**ASR**LIB_c\r\n";

        $param = array();
        $param['param'] = $data;


        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);

        curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, TRUE);
        curl_setopt($ch, CURLOPT_AUTOREFERER, TRUE);
        curl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
        curl_setopt($ch, CURLOPT_NOSIGNAL, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $auth);

        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT_MS, 3000);
        curl_setopt($ch, CURLOPT_TIMEOUT_MS, $time);
    
    //一下两行注释掉就是用GET访问
        curl_setopt($ch, CURLOPT_POST, TRUE);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $param);
    
    $response = curl_exec($ch);
   echo($response);

```


6 定期备份网关的plugin下的规则文件
```
#coding=utf-8
# 备份老版网关后台的配置数据
import os
import time
import commands

source='/home/www/gateway/orange/plugins'
print 'backup files:',source


target_dir='/home/backup/gw-plugin/'
target=target_dir+'gw_'+time.strftime('%Y%m%d%H%M%S')+'.tar.gz'


cmd='tar -zcvf %s %s '%(target,''.join(source))

if os.system(cmd)==0:
	print 'successful backup to',target
else:
	print 'failed backup'



```


7 统计
awk -F, '{count[$1]++}END {for(i in count) {print i,count[i]}}' /home/nginx/logs/test.xesv5.com_access.log

8 统计网关和后端连接中建立tcp连接的数量

后端服务器集群ip范围:
10.20.29.82-10.20.29.96 15台机器


```
#!/bin/bash

YEAR=`date +%Y年%m月%d日%H时%M分`

echo "===============[$YEAR:]================"
netstat -na|grep ESTABLISHED |awk '{count[$5]++} END {for(i in count) {print i,count[i] }}' |grep '10.20.29.[8|9]' | grep -v '10.20.29.80' | grep -v 10.20.29.81| grep -v 10.20.29.97| grep -v 10.20.29.98| grep -v 10.20.29.99 |sort

netstat -na|grep ESTABLISHED |awk '{count[$5]++} END {for(i in count) {print i,count[i] }}' |grep '10.20.29.[8|9]' | grep -v '10.20.29.80' | grep -v 10.20.29.81| grep -v 10.20.29.97| grep -v 10.20.29.98| grep -v 10.20.29.99 |sort | awk -v sum=0 '{sum+=$NF}END{print sum}'


效果：
===============[2019年01月15日17时13分:]================
10.20.29.82:80 12
10.20.29.83:80 14
10.20.29.84:80 14
10.20.29.85:80 13
10.20.29.86:80 13
10.20.29.87:80 11
10.20.29.88:80 11
10.20.29.89:80 10
10.20.29.90:80 11
10.20.29.91:80 11
10.20.29.92:80 11
10.20.29.93:80 12
10.20.29.94:80 12
10.20.29.95:80 12
10.20.29.96:80 12
180
```




